<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generative Dialogue - Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b405a;
            --accent-color: #e17b43;
            --light-bg: #f5f5f5;
            --dark-bg: #2a2d3e;
            --text-color: #333;
            --light-text: #fff;
            --border-color: #ddd;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .setup-container {
            max-width: 600px;
            width: 90%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
        }
        
        .logo-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            padding: 10px;
            background-color: var(--primary-color);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        p {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #555;
        }
        
        .video-preview {
            width: 100%;
            height: 300px;
            background-color: #333;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        #dailyContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .status-container {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3b405a;
        }
        
        .status-container.error {
            background-color: #fff5f5;
            border-left-color: #e53e3e;
            color: #e53e3e;
        }
        
        .status-container.success {
            background-color: #f0fff4;
            border-left-color: #38a169;
            color: #38a169;
        }
        
        .loading-spinner {
            display: none;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(59, 64, 90, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #2d3142;
        }
        
        .btn:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        
        .btn-icon {
            width: 20px;
            height: 20px;
        }
        
        .hide {
            display: none !important;
        }
        
        /* Daily.co UI hiding */
        .daily-video-overlay {
            display: none !important;
        }
        
        .daily-nameplate {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="logo-container">
            <img src="./images/EarthLogoSmallTransparent.png" alt="Generative Dialogue Logo" class="logo">
        </div>
        
        <h1>Welcome to Generative Dialogue</h1>
        
        <p>Before joining the dialogue, let's set up your camera and microphone to ensure everything works properly.</p>
        
        <div class="status-container" id="statusContainer">
            Ready to begin setup. Click the button below to start.
        </div>
        
        <div class="video-preview" id="videoPreview">
            <div id="dailyContainer"></div>
        </div>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div class="spinner-text">Setting up your connection...</div>
        </div>
        
        <button id="setupButton" class="btn">
            <img src="./images/icons/Camera, On.svg" alt="Camera" class="btn-icon">
            Set Up Camera & Microphone
        </button>
    </div>
    
    <script>
        // Elements
        const setupButton = document.getElementById('setupButton');
        const statusContainer = document.getElementById('statusContainer');
        const videoPreview = document.getElementById('videoPreview');
        const dailyContainer = document.getElementById('dailyContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // State variables
        let callFrame = null;
        let isSetupComplete = false;
        let setupInProgress = false;
        let joinTimeout = null;
        let mediaStream = null;
        
        // Update status message
        function updateStatus(message, type = '') {
            statusContainer.textContent = message;
            statusContainer.className = 'status-container';
            
            if (type) {
                statusContainer.classList.add(type);
            }
        }
        
        // Show loading spinner
        function showLoading(show) {
            if (show) {
                loadingSpinner.style.display = 'flex';
            } else {
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Start the setup process - using direct WebRTC
        async function startSetup() {
            if (setupInProgress) return;
            
            setupInProgress = true;
            setupButton.disabled = true;
            updateStatus('Requesting camera and microphone access...', '');
            showLoading(true);
            
            try {
                // First try with both audio and video
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    
                    updateStatus('Camera and microphone connected successfully!', 'success');
                } catch (initialError) {
                    console.error('Initial access error:', initialError);
                    
                    // If that fails, try with just video (audio might be in use or not working)
                    if (initialError.name === 'NotReadableError' && initialError.message.includes('audio')) {
                        try {
                            updateStatus('Audio device busy, trying with video only...', '');
                            mediaStream = await navigator.mediaDevices.getUserMedia({ 
                                video: true, 
                                audio: false 
                            });
                            updateStatus('Connected with video only. Audio device is unavailable.', 'success');
                        } catch (videoOnlyError) {
                            // If video-only fails too, try with just audio
                            try {
                                updateStatus('Video device busy, trying with audio only...', '');
                                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                                    video: false, 
                                    audio: true 
                                });
                                updateStatus('Connected with audio only. Video device is unavailable.', 'success');
                            } catch (audioOnlyError) {
                                // Re-throw the error if all attempts fail
                                throw initialError;
                            }
                        }
                    } else {
                        // Re-throw the error for handling in the catch block
                        throw initialError;
                    }
                }
                
                // Create a video element to display the preview
                const videoEl = document.createElement('video');
                videoEl.srcObject = mediaStream;
                videoEl.autoplay = true;
                videoEl.muted = true;
                videoEl.playsinline = true;
                videoEl.style.width = '100%';
                videoEl.style.height = '100%';
                videoEl.style.objectFit = 'cover';
                
                // Clear the container and add the video
                dailyContainer.innerHTML = '';
                dailyContainer.appendChild(videoEl);
                
                // Store device information
                const videoTracks = mediaStream.getVideoTracks();
                const audioTracks = mediaStream.getAudioTracks();
                
                const deviceInfo = {
                    timestamp: Date.now(),
                    setupComplete: true,
                    cameraEnabled: videoTracks.length > 0,
                    microphoneEnabled: audioTracks.length > 0,
                    videoDeviceId: videoTracks.length > 0 ? videoTracks[0].getSettings().deviceId : null,
                    audioDeviceId: audioTracks.length > 0 ? audioTracks[0].getSettings().deviceId : null,
                    setupMethod: 'getUserMedia',
                    fallbackUsed: videoTracks.length === 0 || audioTracks.length === 0
                };
                
                // Store setup info
                localStorage.setItem('generativeDialogueSetup', JSON.stringify(deviceInfo));
                
                // Update UI
                isSetupComplete = true;
                setupInProgress = false;
                showLoading(false);
                setupButton.textContent = 'Continue to Dialogue';
                setupButton.disabled = false;
                setupButton.onclick = proceedToDialogue;
                
            } catch (error) {
                console.error('Media access error:', error);
                
                let errorMessage = 'Could not access camera or microphone.';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permission denied. Please allow camera and microphone access.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera or microphone found on your device.';
                } else if (error.name === 'NotReadableError') {
                    // Provide more detailed guidance for NotReadableError
                    if (error.message.includes('audio')) {
                        errorMessage = 'Microphone is already in use by another application. Please close other applications that might be using your microphone (like Zoom, Teams, or other browser tabs with video calls).';
                    } else if (error.message.includes('video')) {
                        errorMessage = 'Camera is already in use by another application. Please close other applications that might be using your camera (like Zoom, Teams, or other browser tabs with video calls).';
                    } else {
                        errorMessage = 'Camera or microphone is already in use by another application. Please close other applications using these devices and try again.';
                    }
                } else if (error.name === 'AbortError') {
                    errorMessage = 'Hardware error accessing media devices. Try unplugging and reconnecting your camera/microphone.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'Your device does not meet the required constraints. Try a different camera or microphone.';
                }
                
                updateStatus(`Error: ${errorMessage}`, 'error');
                
                // Add a retry button to the status container
                const retryButton = document.createElement('button');
                retryButton.className = 'btn';
                retryButton.style.marginTop = '10px';
                retryButton.textContent = 'Try Again';
                retryButton.onclick = () => {
                    setupInProgress = false;
                    setupButton.disabled = false;
                    startSetup();
                };
                
                // Clear any existing retry buttons
                const existingRetry = statusContainer.querySelector('.btn');
                if (existingRetry) {
                    statusContainer.removeChild(existingRetry);
                }
                
                statusContainer.appendChild(retryButton);
                setupButton.disabled = false;
                setupInProgress = false;
                showLoading(false);
            }
        }
        
        // Clean up media resources
        function cleanupMedia() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }
        
        // Proceed to the main dialogue page
        function proceedToDialogue() {
            if (!isSetupComplete) {
                updateStatus('Setup not complete. Please complete setup first.', 'error');
                return;
            }
            
            // Clean up resources
            cleanupMedia();
            
            // Navigate to the main dialogue page
            window.location.href = 'generative-dialogue-STEP-BY-STEP-FIX.html';
        }
        
        // Set up initial button click handler
        setupButton.addEventListener('click', startSetup);
        
        // Clean up when leaving the page
        window.addEventListener('beforeunload', cleanupMedia);
    </script>
</body>
</html>